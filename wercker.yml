---
box: wercker/golang
build:
  steps:
    - setup-go-workspace
    - script:
        code: |
            cd $WERCKER_SOURCE_DIR
            go version
            go get -t github.com/lox/httpcache
        name: "go get"
    - script:
        code: "go build -ldflags \"-X main.version $(git describe --tags --always)\" cli/httpcache.go\n"
        name: "go build"
    - script:
        code: "go test -v\n"
        name: "go test"
    - script:
        code: "cp httpcache \"$WERCKER_OUTPUT_DIR\""
        name: "copy binary"
deploy:
  steps:
    - script:
        name: get version from binary
        code: export APP_VERSION=$(./httpcache --version)

    - github-create-release:
        token: $GITHUB_ACCESS_TOKEN
        tag: $APP_VERSION
        draft: true

    - github-upload-asset:
        token: $GITHUB_ACCESS_TOKEN
        file: httpcache

